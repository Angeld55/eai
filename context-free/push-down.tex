\section{Недетерминирани стекови автомати}

\index{автомат!недетерминиран стеков}
\mynote{На англ. {\em Push-down automaton}. В този курс няма да разглеждаме детерминирани стекови автомати. Когато кажем стеков автомат, ще имаме предвид недетерминиран стеков автомат.
  Означаваме $\Sigma_\varepsilon \df \Sigma \cup \{\varepsilon\}$ и $\Gamma^{\leq 2} \df \{\varepsilon\} \cup \Gamma \cup \Gamma^2$.}
{\bf Недетерминиран стеков автомат} е седморка от вида
\[P = \PDA,\] където:
\begin{itemize}
\item
  $Q$ е крайно множество от състояния;
\item  
  $\Sigma$ е крайна входна азбука;
\item
  $\Gamma$ е крайна стекова азбука;
\item
  $\sharp \in \Gamma$ е символ за дъно на стека;
\item
  \mynote{Дефиницията на стеков автомат има много вариации, всички еквивалентни помежду си}
  $\Delta:Q\times\Sigma_\varepsilon\times \Gamma \rightarrow \Ps(Q\times\Gamma^{\leq 2})$ 
  е функция на преходите;    
\item
  $\qstart \in Q$ е начално състояние;
\item
  $\qaccept \in Q$ е заключителното състояние.
\end{itemize}

\mynote{На англ. Instanteneous description}
{\em Моментно описание} (или конфигурация) на изчислението със стеков автомат представлява тройка от вида $(q,\alpha,\gamma) \in Q\times\Sigma^\star\times\Gamma^\star$,
т.е. автоматът се намира в състояние $q$, думата, която остава да се прочете е $\alpha$,
а съдържанието на стека е думата $\gamma$.
Удобно е да въведем бинарната релация $\vdash_P$ над $Q\times\Sigma^\star\times\Gamma^\star$,
която ще ни казва как моментното описание на автомата $P$ се променя след изпълнение на една стъпка:
\begin{align*}
  (p,\varepsilon) \in \Delta(q,x,A) & \implies (q,x\alpha,A\gamma) \vdash_P (p,\alpha,\gamma)\\
  (p,\beta) \in \Delta(q,\varepsilon,Y) & \implies (q,\alpha,Y\gamma) \vdash_P (p,\alpha,\beta\gamma).
\end{align*}
Рефлексивното и транзитивно затваряне на $\vdash_P$ ще означаваме с $\vdash^\star_P$.
Сега вече можем да дадем дефиниция на език, разпознаван от стеков автомат $P$.
\mynote{Възможно е да се даде и друга еквивалентна дефиниция - разпознаване с празен стек.}
Езикът $\L(P)$, който се разпознава от $P$, има следната дефиниция:
\[\L(P) = \{\ \omega \in \Sigma^\star \mid (\qstart,\omega,\sharp) \vdash^\star_P (\qaccept,\varepsilon,\varepsilon)\ \}.\]

\input{context-free/push-down-solved-examples}

\begin{framed}
  \begin{lemma}
    За всяка безконтекстна граматика $G$,
    съществува стеков автомат $P$, такъв че $\L(G) = \L(P)$.
  \end{lemma}
\end{framed}
\begin{proof}
  \mynote{\cite[стр. 136]{papadimitriou}}
  % \mynote{Доказателството в \cite[стр. 117]{sipser3} не ми харесва}
  \mynote{Тук приемаме, че винаги правим най-ляв извод в граматиката}
  Нека е дадена безконтекстната граматика $G = \CFG$ в нормална форма на Чомски.
  Нашата цел е да построим стеков автомат
  \[P = \PDA,\] който разпознава $\L(G)$.
  \begin{itemize}
  \item
    $Q = \{\qstart,p,\qaccept\}$;
  \item
    $\Gamma = \Sigma \cup V \cup \{\sharp\}$;
  \item
    Релацията на преходите $\Delta$ дефинираме по следния начин:
    \mynote{Понеже граматиката е в нормална форма на Чомски, то $|\alpha| \leq 2$ и удовлетворяваме дефиницията на $\Delta$.}
    \begin{enumerate}[(1)]
    \item 
      $\Delta(\qstart, \varepsilon, \sharp ) = \{(p,S\sharp)\}$;
    \item
      $\Delta(p,\varepsilon,A) = \{(p,\alpha)\mid A\to_G \alpha\}, \text{ за всяка променлива }A \in V$;
    \item
      $\Delta(p,a,a) = \{(p,\varepsilon)\}, \text{ за всяка буква } a \in \Sigma$;
    \item
      $\Delta(p,\varepsilon,\sharp) = \{(\qaccept, \varepsilon)\}$.
    \end{enumerate}
  \end{itemize}
  
  Ще докажем, че за всяка променлива $A \in V$, за всяка дума $\alpha \in \Sigma^\star$ и $\gamma \in (\Sigma \cup V)^\star$, то е изпълнено, че:
  \mynote{Трябва да се каже, че $S \to^\star_G \alpha \gamma$ го правим като заместваме най-лявата променлива.}
  \begin{enumerate}[(a)]
  \item
    ако $S \derive{\star}_G \alpha \gamma$, то $(p, \alpha, S\sharp) \vdash^\star_P (p, \varepsilon, \gamma\sharp)$;
  \item
    ако $(p, \alpha, \gamma\sharp) \vdash^\star_P (p, \varepsilon, \sharp)$, то $\gamma \derive{\star}_G \alpha$.
  \end{enumerate}
  Тогава, ако вземем $\gamma = \varepsilon$, то ще получим, че
  \begin{align*}
    \alpha \in \L(G) & \iff S \to^\star_G \alpha\\
                     & \iff (p,\alpha,S\sharp) \vdash^\star_P (p, \varepsilon, \sharp) & \comment{\text{от (а) и (б)}}\\
                     & \iff (\qstart,\alpha,\sharp) \vdash^\star_P (\qaccept, \varepsilon, \varepsilon) & \comment{\text{от деф. на }\Delta}\\
                     & \iff \alpha \in \L(P).
  \end{align*}

  Сега преминаваме към доказателствата на двете твърдения.

  \begin{enumerate}[(a)]
  \item
    Индукция по дължината на извода $S \to^\star_G \alpha\gamma$.
    Нека $\ell = 0$. Този случай е тривиален, защото тогава $\alpha = \varepsilon$ и $\gamma = S$.
    Ясно е, че
    \[(p,\varepsilon,S\sharp) \vdash^0_P (p,\varepsilon,S\sharp).\]

    Нека $\ell > 0$ и $S \stackrel{\ell}{\to}_G \alpha\gamma$. Това означава, че този извод може да се запише по следния начин:
    \[S \stackrel{\ell-1}{\to}_G \alpha_1A\gamma_2 \to_G \underbrace{\alpha_1\alpha_2}_{\alpha}\underbrace{\gamma_1\gamma_2}_{\gamma},\]
    където $A \to_G \alpha_2\gamma_1$ е правилото в граматиката, което сме приложили най-накрая. Тогава от И.П. имаме, че
    \begin{equation}
      \label{eq:5}
      (p, \alpha_1, S\sharp) \vdash^\star_P (p, \varepsilon, A\gamma_2\sharp).
    \end{equation}
    Тогава имаме следното изчисление на стековия автомат:
    \begin{align*}
      (p, \alpha_1\alpha_2, S\sharp) & \vdash^\star_P (p, \alpha_2, A\gamma_2\sharp) & \comment{\text{от (\ref{eq:5})}}\\
                                     & \vdash_P (p, \alpha_2, \alpha_2\gamma_1\gamma_2\sharp) & \comment{\text{ред (2) от деф. на }\Delta}\\
                                     & \vdash^\star_P (p, \varepsilon, \gamma_1\gamma_2\sharp) & \comment{\text{ред (3) от деф. на }\Delta}.
    \end{align*}
  \item
    Индукция по броя на стъпките $\ell$ в изчислението на стековия автомат.
    Нека $\ell = 0$. Тогава е ясно, че единствената възможност $\alpha = \varepsilon$ и $\gamma = \varepsilon$.
    Тогава $\varepsilon \derive{\star}_G \varepsilon$.
    
    Нека $\ell > 0$ и $(p, \alpha, \gamma \sharp) \vdash^{\ell}_P (p, \varepsilon, \sharp)$.
    Имаме три избора за първата стъпка в това изчисление.
    \begin{itemize}
    \item
      $\Delta(p,a,a) \ni (p,\varepsilon)$.
      Това означава, че $\alpha = a\beta$, $\gamma = a\gamma_1$ и
      \[(p, \alpha, \gamma \sharp) \vdash_P (p,\beta,\gamma_1\sharp ) \vdash^{\ell-1}_P (p, \varepsilon, \sharp).\]
      Тогава от И.П. получаваме, че $\gamma_1 \derive{\star}_G \beta$ и оттук
      \[\underbrace{a \gamma_1}_{\gamma} \derive{\star}_G \underbrace{a\beta}_{\alpha}.\]
    \item
      $\Delta(p,\varepsilon,A) \ni (p,a)$. Това означава, че $A \to_G a$, $\gamma = A\gamma_1$ и
      \[(p, \alpha, \gamma \sharp) \vdash_P (p,\alpha,a\gamma_1\sharp ) \vdash^{\ell-1}_P (p, \varepsilon, \sharp).\]
      Тогава от И.П. получаваме, че $a\gamma_1 \derive{\star}_G \alpha$ и оттук
      \[\underbrace{A\gamma_1}_{\gamma} \derive{\star}_G \alpha.\]
    \item
      Нека $\Delta(p,\varepsilon,A) \ni (p,BC)$. Това означава, че $A \to_G BC$, $\gamma = A\gamma_1$ и
      \[(p, \alpha, \gamma \sharp) \vdash_P (p,\alpha, BC\gamma_1\sharp ) \vdash^{\ell-1}_P (p, \varepsilon, \sharp).\]
      Тогава от И.П. получаваме, че
      $BC\gamma_1 \derive{\star}_G \alpha$. Заключаваме, че
      \[ \underbrace{A\gamma_1}_{\gamma}\derive{\star}_G \alpha.\]
    \end{itemize}
  \end{enumerate}
\end{proof}

\begin{framed}
  \begin{lemma}
    За всеки стеков автомат $P$, съществува безконтекстна граматика $G$, такава че $\L(P) = \L(G)$.
  \end{lemma}
\end{framed}
\begin{proof}
  Нека е даден стековия автомат
  \[P = \PDA.\]
  Ще дефинираме безконтекстна граматика $G$, за която $\L(P) = \L(G)$.
  Променливите на граматика са 
  \[V = \{[q,A,p] \mid q,p \in Q, A \in \Gamma\}.\]
  Правилата на $G$ са следните:
  \begin{itemize}
  \item
    Началната променлива е $[\qstart,\sharp,\qaccept]$;
  \item
    Нека имаме $(r,BC) \in \Delta(q, a, A)$, където $a \in \Sigma_\varepsilon$.
    Тогава добавяме правилата в граматиката:
    \[[q,A,p] \to_G a[r,B_1,q'][q',B_2,p],\]
    за всеки две състояние $q'$ и $p$.
  \item
    Нека имаме $(r,B) \in \Delta(q, a, A)$, където $a \in \Sigma_\varepsilon$.
    Тогава добавяме правилата в граматиката:
    \[[q,A,p] \to_G a[r,B,p],\]
    за всяко състояние $p \in Q$.
  \item
    Нека имаме $(p,\varepsilon) \in \Delta(q,a,A)$, където $a \in \Sigma_\varepsilon$.
    Тогава добавяме правилата в граматиката:
    \[[q,A,p] \to a.\]
  \end{itemize}
  Трябва да докажем, че за произволна дума $\alpha \in \Sigma^\star$, произволни състояния $q,p \in Q$,
  и произволен символ $A \in \Gamma$, е изпълнено, че:
  \[[q,A,p] \derive{\star}_G \alpha\ \Leftrightarrow\ (q,\alpha,A) \vdash^\star_{P} (p,\varepsilon,\varepsilon).\]
  \begin{description}
  \item[$(\Rightarrow)$]
    С пълна индукция по броят на стъпките $\ell$ в изчислението на стековия автомат $P$ ще докажем, че:
    \[(q,\alpha,A) \vdash^\star_P (p,\varepsilon,\varepsilon)\ \implies\ [q,A,p] \derive{\star}_G \alpha.\]
    Ако $\ell = 1$, то е лесно, защото $\alpha = a \in \Sigma_\varepsilon$.
    Тогава $(p,\varepsilon) \in \Delta(q,a,A)$ и според конструкцията на граматиката $G$ имаме правилото $[q,A,p] \to_G a$.
    
    Ако $\ell > 1$, то в зависимост от първата стъпка на изчислението, имаме два случая.
    Нека $\alpha = a\beta$, където $a \in \Sigma_\varepsilon$.
    \begin{itemize}
    \item 
      Ако $\Delta(q,a,A) \ni (r,B)$, то имаме, че:
      \[(q,a\beta,A) \vdash_P (r,\beta,B) \vdash^{\ell-1}_P (p, \varepsilon, \varepsilon).\]
      Тогава от И.П. получаваме, че
      \[[r,B,p] \derive{\star}_G \beta.\]
    \item
      Ако $\Delta(q, a, A) \ni (r, BC)$, то имаме, че:
      \[(q, a\beta, A) \vdash_P (r, \beta, BC) \vdash^{\ell-1}_P (p, \varepsilon, \varepsilon).\]      
      За $\ell-1$ стъпки трябва да стигнем от стек с големина $2$ до празен стек.
      Това означава, че можем да разбием думата $\beta$ на две части, $\beta = \beta_1\beta_2$, със свойството, че след като прочетем $\beta_1$,
      то стекът има големина $1$ и след като прочетем $\beta_2$, то стекът е празен.
      \mynote{Да обърнем внимание, че в междинните стъпки от двете изчисления, стекът може да расте.}
      Това означава, че съществува състояние $q'$, за което можем да разбием изчислението по следния начин:
      \begin{align*}
        & (r, \beta_1, B) \vdash^{\ell_1}_P (q',\varepsilon,\varepsilon)\\
        & (q', \beta_2, C) \vdash^{\ell_2}_P (p,\varepsilon,\varepsilon).
      \end{align*}
      където $\ell_1 + \ell_2 = \ell - 1$.    
      Сега от {\bf И.П.} получаваме:
      \begin{align*}
        & (r, \beta_1, B) \vdash^{\ell_1}_P (q', \varepsilon, \varepsilon) \implies [r, B, q'] \derive{\star}_G \beta_1\\
        & (q', \beta_2, C) \vdash^{\ell_2}_P (p, \varepsilon, \varepsilon) \implies [q', C, p] \derive{\star}_G \beta_2.
      \end{align*}
      Тогава от правилата за извод в граматика получваме, че
      \[[r,B,q'][q',C,p] \derive{\star}_G \beta_1\beta_2.\]
      Понеже имаме, че $\Delta(q,a,A) \ni (r,BC)$, то в граматиката имаме правилото
      \[[q,A,p] \to_G a[r,B,q'][q',C,p].\]
      Обединявайки всичко, получаваме извода
      \[[q,A,p] \derive{\star}_G \underbrace{a\beta_1\beta_2}_{\alpha}.\]
    \end{itemize}
  \item[$(\Leftarrow)$]
    Този път с пълна индукция по дължината на извода $\ell$ в граматиката $G$ ще докажем, че
    \[[q,A,p] \derive{\star}_G \alpha \implies (q,\alpha,A) \vdash^\star_P (p,\varepsilon,\varepsilon).\]
    Ако $\ell = 1$, то имаме $[q,A,p] \rightarrow \alpha$, където $\alpha \in \Sigma_\varepsilon$.
    Този случай е ясен от дефиницията на граматиката $G$, т.е. $\Delta(q,a,A) \ni (p,\varepsilon)$.

    Ако $\ell > 1$, то имаме, че $\alpha = a\beta$ и според правилата на граматиката $G$ имаме два случая.
    \mynote{Тук отново е възможно $a = \varepsilon$. Това не е проблем, защото правим индукция по дължината на извода, а не по дължината на думата $\alpha$.}
    Ако
    \[[q,A,p] \derive{1}_G a[r,B,p] \derive{\ell-1}_G a\beta,\]
    то директно прилагаме И.П. и получаваме, че
    $(r, \beta, B) \vdash^\star_P (p, \varepsilon, \varepsilon)$ и накрая получаваме, че
    \[(q, a\beta, A) \vdash^\star_P (p, \varepsilon, \varepsilon).\]
    Сега да разгледаме втория случай:
    \[[q,A,p] \derive{1}_G a[r,B,q'][q',C,p] \derive{\ell-1}_G a\beta.\]
    От \Proposition{grammar:divide} следва, че имаме разбиване на думата $\beta$ като $\beta = \beta_1\beta_2$, където 
    \begin{align*}
      & [r,B,q'] \derive{\ell_1}_G \beta_1\\
      & [q',C,p] \derive{\ell_2}_G \beta_2.
    \end{align*}
    където $\ell_1 + \ell_2 = \ell - 1$.
    От {\bf И.П.} получаваме, че 
    \begin{align*}
      & [r,B,q'] \derive{\ell_1}_G \beta_1 \implies (r,\beta_1,B) \vdash^\star_P (q',\varepsilon,\varepsilon) \\
      & [q',C,p] \derive{\ell_2}_G \beta_2 \implies (q',\beta_2,C) \vdash^\star_P (p,\varepsilon,\varepsilon).
    \end{align*}
    Правилото
    \[[q,A,p] \rightarrow_G a[r,B,q'][q',C,p]\]
    е добавено в граматиката, защото $\Delta(q,a,A) \ni (r, BC)$. 
    Обединявайки всичко, което знаем, получаваме:
    \begin{align*}
      (q, a\beta, A) & \vdash_P (r, \beta_1\beta_2, BC)\\
                     & \vdash^\star_P (q', \beta_2, C)\\
                     & \vdash^\star_P (p, \varepsilon, \varepsilon).
    \end{align*}    
  \end{description}
\end{proof}

Предишните две леми ни дават следната теорема.
\begin{framed}
\begin{thm}
  \label{th:push-down-context-free}
  Класът на езиците, които се разпознават от краен стеков автомат съвпада с
  класа на безконтекстните езици.
\end{thm}
\end{framed}

\begin{example}
  Нека е дадена граматиката $G$ с правила 
  \begin{align*}
    & S \to AS\ |\ BS\ |\ \varepsilon\\
    & A \to aA\ |\ a\\
    & B \to Bb\ |\ b.
  \end{align*}
  Ще построим стеков автомат $P = \PDA$, такъв че $\L(P) = \L(G)$.
  \begin{itemize}
  \item
    $\Sigma = \{a,b\}$;
  \item 
    $\Gamma = \{A,S,B,a,b,\sharp\}$;
  \item
    $Q = \{\qstart,q,\qaccept\}$;
  \item
    Дефинираме релацията на преходите, следвайки конструкцията от \Theorem{push-down-context-free}:
    \begin{itemize}
    \item
      $\Delta(\qstart, \varepsilon, \sharp) = \{(q, S\sharp)\}$;
    \item 
      $\Delta(q, \varepsilon, S) = \{(q, AS), (q, BS), (q, \varepsilon)\}$;
    \item
      $\Delta(q, \varepsilon, A) = \{(q, aA), (q, a)\}$;
    \item
      $\Delta(q, \varepsilon, B) = \{(q, Bb), (q, b)\}$;
    \item
      $\Delta(q, a, a) = \{(q, \varepsilon)\}$;
    \item
      $\Delta(q, b, b) = \{(q, \varepsilon)\}$;
    \item
      $\Delta(q, \varepsilon, \sharp) = \{(\qaccept,\varepsilon)\}$;
    \end{itemize}
  \end{itemize}
\end{example}

\begin{framed}
  \begin{thm}
    \label{th:intersection-context-reg}
    Нека $L$ e безконтекстен език и $R$ е регулярен език.
    Тогава тяхното сечение $L \cap R$ е безконтекстен език.
  \end{thm}  
\end{framed}
\begin{hint}
  \mynote{\cite[стр. 144]{papadimitriou}}
  Нека имаме стеков автомат
  \[P = \pair{Q',\Sigma,\Gamma,\sharp, \Delta', \qstart', \qaccept'}, \text{ където } \L(P) = L,\]
  и краен тотален детерминиран автомат 
  \[\A = \pair{Q'', \Sigma, \qstart'', \delta'', F''}, \text{ където } \L(\A) = R.\]
  \mynote{Сравнете с конструкцията от \Proposition{automata-cap}.}
  Ще определим нов стеков автомат
  \[\M = \PDA,\]
  където
  \begin{itemize}
  \item 
    $Q = Q' \times Q''$;
  \item
    $\qstart = \pair{\qstart',\qstart''}$;
  \item
    $F = \{\qaccept'\} \times F''$;
  \item 
    Функцията на преходите $\Delta$ е дефинирана както следва:
    \begin{itemize}
    \item 
      \mynote{Симулираме едновременно изчислението и на двата автомата.}
      Ако $(r_1,Z) \in \Delta'(q_1, a, Y)$, то
      \[(\pair{r_1,\delta''(q_2,a)}, Z) \in \Delta(\pair{q_1,q_2},a,Y).\]
    \item
      \mynote{Нищо не четем от входната дума, следователно правим празен ход на $\A$}
      Ако $(r_1,Z) \in \Delta'(q_1,\varepsilon,Y)$ и всяко $q_2 \in Q''$, то
      \[(\pair{r_1,q_2}, Z) \in \Delta(\pair{q_1,q_2},\varepsilon,Y).\]
    \item
      \mynote{\writedown Докажете, че $\L(\M) = \L(P) \cap \L(\A)$ !}
      $\Delta$ не съдържа други преходи;
    \end{itemize}
  \end{itemize}

  \begin{itemize}
  \item
    \mynote{Индукция по броя стъпки в изчислението на $\M$.}
    Докажете, че ако $(\pair{q_1,q_2},\alpha,\gamma) \vdash^\star_\M (\pair{p_1,p_2},\varepsilon,\varepsilon)$, то
    $(q_1,\alpha,\gamma) \vdash^\star_P (p_1,\varepsilon,\varepsilon)$ и $(q_2,\alpha) \vdash^\star_\A (p_2,\varepsilon)$.
  \item
    \mynote{Индукция по броя стъпки в изчислението на $P$.}
    Докажете, че ако $(q_1,\alpha,\gamma) \vdash^\star_P (p_1,\varepsilon,\varepsilon)$ и $(q_2,\alpha) \vdash^\star_\A (p_2,\varepsilon)$, то
    $(\pair{q_1,q_2},\alpha,\gamma) \vdash^\star_\M (\pair{p_1,p_2},\varepsilon,\varepsilon)$.
  \end{itemize}
  
\end{hint}

\Theorem{intersection-context-reg} е удобна, когато искаме да докажем, че даден език не е безконтекстен.
С нейна помощ можем да сведем езика до друг, за който вече знаем, че не е безконтекстен.

\begin{example}
  Езикът $L = \{\omega \in \{a,b,c\}^\star \mid N_a(\omega) = N_b(\omega) = N_c(\omega)\}$ не е безконтекстен.
  Да допуснем, че $L$ е безконтекстен език.
  Тогава \[L^\prime = L \cap \L(a^\star b^\star c^\star)\] също е безконтекстен език.
  Но $L^\prime = \{a^nb^nc^n \mid n \in \Nat\}$, за който знаем от \Problem{anbncn}, че {\em не} е безконтекстен.
  Достигнахме до противоречие. Следователно, $L$ не е безконтекстен език.
\end{example}

\begin{framed}
  \begin{remark}
    Не е вярно, че сечението на всеки два безконтекстни езика е безконтекстен език.

    Например, $L_1 = \{a^nb^nc^k \mid n,k\in\Nat\}$ и $L_2 = \{a^kb^nc^n \mid n,k\in\Nat\}$
    са безконтекстни езици, но ние знаем, че
    \[L_1 \cap L_2 = \{a^nb^nc^n \mid n \in \Nat\}\]
    не е безконтекстен.
  \end{remark}
\end{framed}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../eai"
%%% End: 
