\section{Недетерминирани стекови автомати}

\index{автомат!недетерминиран стеков}
\marginpar{На англ. {\em Push-down automaton}}
\marginpar{В този курс няма да разглеждаме детерминирани стекови автомати. Когато кажем стеков автомат, ще имаме предвид недетерминиран стеков автомат.
  Означаваме $\Sigma_\varepsilon = \Sigma \cup \{\varepsilon\}$ и $\Gamma^{\leq 2} = \{\varepsilon\} \cup \Gamma \cup \Gamma^2$.}
{\bf Недетерминиран стеков автомат} е седморка от вида
\[P = \PDA,\] където:
\begin{itemize}
\item
  $Q$ е крайно множество от състояния;
\item  
  $\Sigma$ е крайна входна азбука;
\item
  $\Gamma$ е крайна стекова азбука;
\item
  $\sharp \in \Gamma$ е символ за дъно на стека;
\item
  \marginpar{Дефиницията на стеков автомат има много вариации, всички еквивалентни помежду си}
  $\Delta:Q\times\Sigma_\varepsilon\times \Gamma \rightarrow \Ps(Q\times\Gamma^{\leq 2})$ 
  е функция на преходите;    
\item
  $\qstart \in Q$ е начално състояние;
\item
  $\qaccept \in Q$ е заключителното състояние.
\end{itemize}

\marginpar{На англ. Instanteneous description}
{\em Моментно описание} (или конфигурация) на изчислението със стеков автомат представлява тройка от вида $(q,\alpha,\gamma) \in Q\times\Sigma^\star\times\Gamma^\star$,
т.е. автоматът се намира в състояние $q$, думата, която остава да се прочете е $\alpha$,
а съдържанието на стека е думата $\gamma$.
Удобно е да въведем бинарната релация $\vdash_P$ над $Q\times\Sigma^\star\times\Gamma^\star$,
която ще ни казва как моментното описание на автомата $P$ се променя след изпълнение на една стъпка:
\begin{align*}
  (p,\varepsilon) \in \Delta(q,x,A) & \implies (q,x\alpha,A\gamma) \vdash_P (p,\alpha,\gamma)\\
  (p,\beta) \in \Delta(q,\varepsilon,Y) & \implies (q,\alpha,Y\gamma) \vdash_P (p,\alpha,\beta\gamma).
\end{align*}
Рефлексивното и транзитивно затваряне на $\vdash_P$ ще означаваме с $\vdash^\star_P$.
Сега вече можем да дадем дефиниция на език, разпознаван от стеков автомат $P$.
\marginpar{Възможно е да се даде и друга еквивалентна дефиниция - разпознаване с празен стек.}
Езикът $\L(P)$, който се разпознава от $P$, има следната дефиниция:
\[\L(P) = \{\ \omega \in \Sigma^\star \mid (\qstart,\omega,\sharp) \vdash^\star_P (\qaccept,\varepsilon,\varepsilon)\ \}.\]

\begin{example}
  \label{ex:anbn}
  За езика $L = \{a^nb^n\mid n\in\Nat\}$ съществува стеков автомат $P$, такъв че
  $L = \L(P)$.
  Да разгледаме
  \[P = \PDA,\] където
  \begin{itemize}
  \item
    $Q = \{q,p,f\}$;
  \item
    $\qstart = q$;
  \item
    $\qaccept = f$;
  \item
    $\Sigma = \{a,b\}$;
  \item
    $\Gamma = \{\sharp,a\}$;
  \item
    Релацията на преходите $\Delta$ има следната дефиниция:
    \begin{enumerate}[(1)]
    \item
      $\Delta(q,a,\sharp) = \{(q, a\sharp), (p, a\sharp)\}$;
    \item
      $\Delta(q,a,a) = \{(q, aa), (p, aa)\}$;
    \item 
      $\Delta(q,\varepsilon,\sharp) = \{(f,\varepsilon)\}$\quad \comment{трябва да разпознаем и $\varepsilon$};
    \item 
      $\Delta(p, b, a) = \{(p,\varepsilon)\}$;
    \item
      $\Delta(p, \varepsilon, \sharp) = \{(f, \varepsilon)\}$.
    \item
      За всички останали тройки $(r,x,y)$, нека $\Delta(r,x,y) = \emptyset$.
    \end{enumerate}
  \end{itemize}
  
  Да видим как думата $a^2b^2$ се разпознава от автомата с празен стек:
  \begin{align*}
    (q, a^2b^2, \sharp) & \vdash_P (q, ab^2, a\sharp) & \comment{\text{правило }(1)}\\
                        & \vdash_P (p, b^2, aa\sharp) & \comment{\text{правило }(2)}\\
                        & \vdash_P (p, b, a\sharp) & \comment{\text{правило }(4)}\\
                        & \vdash_P (p, \varepsilon, \sharp) & \comment{\text{правило }(4)}\\
                        & \vdash_P (f, \varepsilon, \varepsilon) & \comment{\text{правило }(5)}
  \end{align*}
  \marginpar{\writedown Докажете, че $L = \L(P)$!}
  Получихме, че
  \[(\qstart, a^2b^2, \sharp) \vdash^\star_P (\qaccept, \varepsilon, \varepsilon),\]
  откъдето следва, че $a^2b^2 \in \L(P)$.

  \begin{enumerate}[a)]
  \item
    Докажете с индукция по $n$, че за всяко естествено число $n$,
    \begin{align*}
      & (q, a^n\beta, \sharp) \vdash^n_P (q, \beta, a^n\sharp)\\
      & (p, b^n, a^n\sharp) \vdash^n_P (p, \varepsilon,\sharp).
    \end{align*}
    Заключете, че $L \subseteq \L(P)$.
  \item
    \marginpar{Индукция по броя на стъпките в изчислението на стековия автомат}
    Докажете, че за всеки три думи $\alpha,\beta, \gamma \in \{a,b\}^\star$ е изпълнено, че:
    \begin{align*}
      (q, \alpha\beta, \sharp) \vdash^n_P (q, \beta, \gamma\sharp)  & \implies \alpha = \gamma = a^n\\
      (p, \beta, \gamma\sharp) \vdash^n_P (p, \varepsilon, \sharp) & \implies \beta = b^n\ \&\ \gamma = a^n,
    \end{align*}
    Оттук заключете, че $\L(P) \subseteq L$.    
  \end{enumerate}
\end{example}

\begin{example}
  \label{ex:omega-omega-r}
  Езикът $L = \{\ \omega\omega^{\rev} \mid \omega \in \{a,b\}^\star\ \}$ се разпознава от стеков автомат
  \[P = \PDA,\] където:
  \begin{itemize}
  \item 
    $Q = \{q,p,f\}$;
  \item
    $\qstart = q$, $\qaccept = f$;
  \item
    $\Sigma = \{a,b\}$, $\Gamma = \{a, b, \sharp\}$;
  \item
    Функцията на преходите $\Delta$ има следната дефиниция:
    \marginpar{За всички липсващи редове в дефиницията на $\Delta$ приемаме, че $\Delta$ връща $\emptyset$}
    \begin{enumerate}[(1)]
    \item 
      $\Delta(q, a, \sharp) = \{(q, a\sharp)\}$;
    \item 
      $\Delta(q, b, \sharp) = \{(q, b\sharp)\}$;
    \item
      $\Delta(q, \varepsilon, \sharp) = \{(q,\varepsilon)\}$;
    \item
      $\Delta(q, a, a) = \{(q, aa), (p, \varepsilon)\}$;
    \item
      $\Delta(q, a, b) = \{(q, ab)\}$;
    \item
      $\Delta(q, b, a) = \{(q, ba)\}$;
    \item
      $\Delta(q, b, b) = \{(q, bb), (p, \varepsilon)\}$;
    \item
      $\Delta(p, a, a) = \{(p,\varepsilon)\}$;
    \item
      $\Delta(p, b, b) = \{(p,\varepsilon)\}$;
    \item
      $\Delta(p, \varepsilon, \sharp) = \{(f,\varepsilon)\}$;
    \end{enumerate}
  \end{itemize}
  Основното наблюдение, което трябва да направим за да разберем конструкцията на автомата е, че
  всяка дума от вида $\omega\omega^{\texttt{rev}}$ може да се запише като $\omega_1aa\omega^{\texttt{rev}}_1$ или $\omega_1bb\omega^{\texttt{rev}}_1$.
  Да видим защо $P$ разпознава думата $abaaba$ с празен стек.
  Започваме по следния начин:
  \begin{align*}
    (q, abaaba,\sharp) & \vdash_P (q, baaba, a\sharp)   & \comment{\text{правило }(1)}\\
                       & \vdash_P (q, aaba, ba\sharp)   & \comment{\text{правило }(6)}\\
                       & \vdash_P (q, aba,  aba\sharp). & \comment{\text{правило }(5)}
  \end{align*}
  Сега можем да направим два избора как да продължим. Състоянието $p$ служи за маркер, което ни казва, че вече сме започнали 
  да четем $\omega^{\texttt{rev}}$. Поради тази причина, продължаваме така:
  \begin{align*}
    (q, aba, aba\sharp) & \vdash_P (p, ba, ba\sharp) & \comment{\text{правило }(4)}\\
                        & \vdash_P (p, a, a\sharp) & \comment{\text{правило }(9)}\\
                        & \vdash_P (p, \varepsilon, \sharp) & \comment{\text{правило }(8)}\\
                        & \vdash_P (f,\varepsilon,\varepsilon). & \comment{\text{правило }(10)}
  \end{align*}
  Да проиграем още един пример. Да видим защо думата $aba$ не се извежда от автомата.
  \begin{align*}
    (q, aba, \sharp) & \vdash_P (q, ba, a\sharp) & \comment{\text{правило }(1)}\\
                     & \vdash_P (q, a, ba\sharp) & \comment{\text{правило }(6)}\\
                     & \vdash_P (q, \varepsilon, aba\sharp). & \comment{\text{правило }(5)}
  \end{align*}
  От последното моментно описание на автомата нямаме нито един преход, следователно
  думата $aba$ не се разпознава от $P$.
  \marginpar{\writedown Докажете, че $L = \L(P)$!}
  \begin{enumerate}[a)]
  \item
    \marginpar{Индукция по дължината на думата $\alpha$}
    Докажете, че за всеки две думи $\alpha, \beta \in \{a,b\}^\star$ е изпълнено, че:
    \begin{align*}
      & |\alpha| = n\ \implies\ (q, \alpha\beta, \sharp) \vdash^n_P (q, \beta, \alpha^{\texttt{rev}}\sharp)\\
      & |\beta| = n\ \implies\ (p, \beta, \beta\sharp) \vdash^n_P (p, \varepsilon, \sharp).
    \end{align*}
    Оттук заключете, че $L \subseteq \L(P)$.
  \item
    \marginpar{Индукция по броя на стъпките в изчислението на стековия автомат}
    Докажете, че за всеки три думи $\alpha,\beta, \gamma \in \{a,b\}^\star$ е изпълнено, че:
    \begin{align*}
      (q, \alpha\beta, \sharp) \vdash^n_P (q, \beta, \gamma\sharp) & \implies \gamma = \alpha^{\rev}\ \&\ |\alpha| = n\\
      (p, \beta, \gamma\sharp) \vdash^n_P (p, \varepsilon, \sharp) & \implies \gamma = \beta\ \&\ |\beta| = n.
    \end{align*}
    Оттук заключете, че $\L(P) \subseteq L$.
  \end{enumerate}
\end{example}

\begin{example}
  Безконтекстният език
  \[L = \{\ \omega \in \{\texttt{[},\texttt{]}\}^\star \mid \texttt{left}(\omega) = \texttt{right}(\omega)\ \}\]
  се разпознава от стековия автомат
  \[P = \PDA,\] където:
  \begin{itemize}
  \item 
    $Q = \{q,f\}$;
  \item
    $\Sigma = \{\texttt{[},\texttt{]}\}$;
  \item
    $\Gamma = \{\texttt{[}, \texttt{]}, \sharp\}$;
  \item
    $\qstart = q$;
  \item
    $\qaccept = f$;
  \item
    Можем да дефинираме релацията на преходите $\Delta$ по следния начин:
    \begin{enumerate}[(1)]
    \item 
      $\Delta(q, \varepsilon, \sharp) = \{(f, \varepsilon)\}$;
    \item
      $\Delta(q, \texttt{[}, \sharp) = \{(q, \texttt{[}\sharp)\}$;
    \item
      $\Delta(q, \texttt{]}, \sharp) = \{(q, \texttt{]}\sharp)\}$;
    \item
      $\Delta(q, \texttt{[}, \texttt{[}) = \{(q, \texttt{[[})\}$;
    \item
      $\Delta(q, \texttt{[}, \texttt{]}) = \{(q, \varepsilon)\}$;
    \item
      $\Delta(q, \texttt{]}, \texttt{[}) = \{(q, \varepsilon)\}$;
    \item
      $\Delta(q, \texttt{]}, \texttt{]}) = \{(q, \texttt{]]})\}$.
    \end{enumerate}
  \end{itemize}
  Да видим защо думата $\texttt{[]]][[} \in \L(P)$.
  \begin{align*}
    (q, \texttt{[]]][[}, \sharp) & \vdash_P (q,\ \texttt{]]][[},\ \texttt{[}\sharp) & \comment{\text{правило }(2)}\\
                                 & \vdash_P (q,\ \texttt{]][[},\ \sharp) & \comment{\text{правило }(6)}\\
                                 & \vdash_P (q,\ \texttt{][[},\ \texttt{]}\sharp) & \comment{\text{правило }(3)}\\
                                 & \vdash_P (q,\ \texttt{[[},\ \texttt{]]}\sharp) & \comment{\text{правило }(7)}\\
                                 & \vdash_P (q,\ \texttt{[},\ \texttt{]}\sharp) & \comment{\text{правило }(5)}\\
                                 & \vdash_P (q,\ \varepsilon,\ \sharp) & \comment{\text{правило }(5)}\\
                                 & \vdash_P (f,\ \varepsilon,\ \varepsilon). & \comment{\text{правило }(1)}
  \end{align*}

  \begin{enumerate}[a)]
  \item
    \marginpar{Индукция по дължината на думата $\alpha$}
    Докажете, че за произволно естествено число $n$ и произволна дума $\alpha \in \{\texttt{[}, \texttt{]}\}^\star$, е изпълнено, че:
    \begin{align*}
      \texttt{[}^n\alpha \in L & \implies (q, \alpha, \texttt{[}^n\sharp) \vdash^\star_P (q, \varepsilon, \sharp)\\
      \texttt{]}^n\alpha \in L & \implies (q, \alpha, \texttt{]}^n\sharp) \vdash^\star_P (q, \varepsilon, \sharp).
    \end{align*}
    Оттук заключете, че $L \subseteq \L(P)$.
  \item
    \marginpar{Индукция по броя на стъпките в изчислението на стековия автомат }
    Докажете, че за произволно естествено число $n$ и произволна дума $\alpha \in \{\texttt{[}, \texttt{]}\}^\star$, е изпълнено, че:
    \begin{align*}
      (q, \alpha, \texttt{[}^n\sharp) \vdash^\star_P (q, \varepsilon, \sharp) & \implies \texttt{[}^n\alpha \in L\\
      (q, \alpha, \texttt{]}^n\sharp) \vdash^\star_P (q, \varepsilon, \sharp) & \implies \texttt{]}^n\alpha \in L.
    \end{align*}
    Оттук заключете, че $\L(P) \subseteq L$.
  \end{enumerate}
\end{example}

\begin{example}
  Езикът
  \[L = \{\ \omega \in \{\texttt{[},\texttt{]}\}^\star \mid \omega\text{ е балансирана дума}\ \}\]
  се разпознава от стековия автомат $P = \PDA$, където:
  \begin{itemize}
  \item 
    $Q = \{q,f\}$;
  \item
    $\qstart = q$;
  \item
    $\qaccept = f$;
  \item
    $\Sigma = \{\texttt{[},\texttt{]}\}$;
  \item
    $\Gamma = \{\texttt{[}, \sharp\}$;
  \item
    Можем да дефинираме релацията на преходите $\Delta$ по следния начин:
    \marginpar{\writedown Докажете, че $L = \L(P)$!}
    \begin{enumerate}[(1)]
    \item 
      $\Delta(q, \varepsilon, \sharp) = \{(f, \varepsilon)\}$;
    \item
      $\Delta(q, \texttt{[}, \sharp) = \{(q, \texttt{[}\sharp)\}$;
    \item
      $\Delta(q, \texttt{[}, \texttt{[}) = \{(q, \texttt{[[})\}$;
    \item
      $\Delta(q, \texttt{]}, \texttt{[}) = \{(q, \varepsilon)\}$;
    \end{enumerate}
  \end{itemize}  
  \begin{enumerate}[(a)]
  \item
    \marginpar{Индукция по дължината на думата $\alpha$}
    Докажете, че за произволно естествено число $n$ и произволна дума $\alpha \in \{\texttt{[}, \texttt{]}\}^\star$, 
    е изпълнено, че:
    \[\texttt{[}^n\alpha \in L\ \implies (q, \alpha, \texttt{[}^n\sharp) \vdash^\star_P (q, \varepsilon, \sharp).\]
    Оттук заключете, че $L \subseteq \L(P)$.
  \item
    \marginpar{Индукция по броя на стъпките в изчислението на стековия автомат.}
    Докажете, че за произволно естествено число $n$ и произволна дума $\alpha \in \{\texttt{[}, \texttt{]}\}^\star$, е изпълнено, че:
    \[(q,\alpha,\texttt{[}^n\sharp) \vdash^\star_P (q, \varepsilon, \sharp)\ \implies\ \texttt{[}^n\alpha \in L.\]
    Оттук заключете, че $\L(P) \subseteq L$.
  \end{enumerate}
\end{example}

\begin{framed}
  \begin{lemma}
    За всяка безконтекстна граматика $G$,
    съществува стеков автомат $P$, такъв че $\L(G) = \L(P)$.
  \end{lemma}
\end{framed}
\begin{proof}
  \marginpar{\cite[стр. 136]{papadimitriou}}
  % \marginpar{Доказателството в \cite[стр. 117]{sipser3} не ми харесва}
  \marginpar{Тук приемаме, че винаги правим най-ляв извод в граматиката}
  Нека е дадена безконтекстната граматика $G = \CFG$ в нормална форма на Чомски.
  Нашата цел е да построим стеков автомат
  \[P = \PDA,\] който разпознава $\L(G)$.
  \begin{itemize}
  \item
    $Q = \{\qstart,p,\qaccept\}$;
  \item
    $\Gamma = \Sigma \cup V \cup \{\sharp\}$;
  \item
    Релацията на преходите $\Delta$ дефинираме по следния начин:
    \marginpar{Понеже граматиката е в нормална форма на Чомски, то $|\alpha| \leq 2$ и удовлетворяваме дефиницията на $\Delta$.}
    \begin{enumerate}[(1)]
    \item 
      $\Delta(\qstart, \varepsilon, \sharp ) = \{(p,S\sharp)\}$;
    \item
      $\Delta(p,\varepsilon,A) = \{(p,\alpha)\mid A\to_G \alpha\}, \text{ за всяка променлива }A \in V$;
    \item
      $\Delta(p,a,a) = \{(p,\varepsilon)\}, \text{ за всяка буква } a \in \Sigma$;
    \item
      $\Delta(p,\varepsilon,\sharp) = \{(\qaccept, \varepsilon)\}$.
    \end{enumerate}
  \end{itemize}
  
  Ще докажем, че за всяка променлива $A \in V$, за всяка дума $\alpha \in \Sigma^\star$ и $\gamma \in (\Sigma \cup V)^\star$, то е изпълнено, че:
  \marginpar{Трябва да се каже, че $S \to^\star_G \alpha \gamma$ го правим като заместваме най-лявата променлива.}
  \begin{enumerate}[(a)]
  \item
    ако $S \to^\star_G \alpha \gamma$, то $(p, \alpha, S\sharp) \vdash^\star_P (p, \varepsilon, \gamma\sharp)$;
  \item
    ако $(p, \alpha, \gamma\sharp) \vdash^\star_P (p, \varepsilon, \sharp)$, то $\gamma \to^\star_G \alpha$.
  \end{enumerate}
  Тогава, ако вземем $\gamma = \varepsilon$, то ще получим, че
  \begin{align*}
    \alpha \in \L(G) & \iff S \to^\star_G \alpha\\
                     & \iff (p,\alpha,S\sharp) \vdash^\star_P (p, \varepsilon, \sharp) & \comment{\text{от (а) и (б)}}\\
                     & \iff (\qstart,\alpha,\sharp) \vdash^\star_P (\qaccept, \varepsilon, \varepsilon) & \comment{\text{от деф. на }\Delta}\\
                     & \iff \alpha \in \L(P).
  \end{align*}

  Сега преминаваме към доказателствата на двете твърдения.

  \begin{enumerate}[(a)]
  \item
    Индукция по дължината на извода $S \to^\star_G \alpha\gamma$.
    Нека $\ell = 0$. Този случай е тривиален, защото тогава $\alpha = \varepsilon$ и $\gamma = S$.
    Ясно е, че
    \[(p,\varepsilon,S\sharp) \vdash^0_P (p,\varepsilon,S\sharp).\]

    Нека $\ell > 0$ и $S \stackrel{\ell}{\to}_G \alpha\gamma$. Това означава, че този извод може да се запише по следния начин:
    \[S \stackrel{\ell-1}{\to}_G \alpha_1A\gamma_2 \to_G \underbrace{\alpha_1\alpha_2}_{\alpha}\underbrace{\gamma_1\gamma_2}_{\gamma},\]
    където $A \to_G \alpha_2\gamma_1$ е правилото в граматиката, което сме приложили най-накрая. Тогава от И.П. имаме, че
    \begin{equation}
      \label{eq:5}
      (p, \alpha_1, S\sharp) \vdash^\star_P (p, \varepsilon, A\gamma_2\sharp).
    \end{equation}
    Тогава имаме следното изчисление на стековия автомат:
    \begin{align*}
      (p, \alpha_1\alpha_2, S\sharp) & \vdash^\star_P (p, \alpha_2, A\gamma_2\sharp) & \comment{\text{от (\ref{eq:5})}}\\
                                     & \vdash_P (p, \alpha_2, \alpha_2\gamma_1\gamma_2\sharp) & \comment{\text{ред (2) от деф. на }\Delta}\\
                                     & \vdash^\star_P (p, \varepsilon, \gamma_1\gamma_2\sharp) & \comment{\text{ред (3) от деф. на }\Delta}.
    \end{align*}
  \item
    Индукция по броя на стъпките $\ell$ в изчислението на стековия автомат.
    Нека $\ell = 0$. Тогава е ясно, че единствената възможност $\alpha = \varepsilon$ и $\gamma = \varepsilon$.
    Тогава $\varepsilon \to^\star_G \varepsilon$.
    
    Нека $\ell > 0$ и $(p, \alpha, \gamma \sharp) \vdash^{\ell}_P (p, \varepsilon, \sharp)$.
    Имаме три избора за първата стъпка в това изчисление.
    \begin{itemize}
    \item
      $\Delta(p,a,a) \ni (p,\varepsilon)$.
      Това означава, че $\alpha = a\beta$, $\gamma = a\gamma_1$ и
      \[(p, \alpha, \gamma \sharp) \vdash_P (p,\beta,\gamma_1\sharp ) \vdash^{\ell-1}_P (p, \varepsilon, \sharp).\]
      Тогава от И.П. получаваме, че $\gamma_1 \to^\star_G \beta$ и оттук
      \[\underbrace{a \gamma_1}_{\gamma} \to^\star_G \underbrace{a\beta}_{\alpha}.\]
    \item
      $\Delta(p,\varepsilon,A) \ni (p,a)$. Това означава, че $A \to_G a$, $\gamma = A\gamma_1$ и
      \[(p, \alpha, \gamma \sharp) \vdash_P (p,\alpha,a\gamma_1\sharp ) \vdash^{\ell-1}_P (p, \varepsilon, \sharp).\]
      Тогава от И.П. получаваме, че $a\gamma_1 \to^\star_G \alpha$ и оттук
      \[\underbrace{A\gamma_1}_{\gamma} \to^\star_G \alpha.\]
    \item
      Нека $\Delta(p,\varepsilon,A) \ni (p,BC)$. Това означава, че $A \to_G BC$, $\gamma = A\gamma_1$ и
      \[(p, \alpha, \gamma \sharp) \vdash_P (p,\alpha, BC\gamma_1\sharp ) \vdash^{\ell-1}_P (p, \varepsilon, \sharp).\]
      Тогава от И.П. получаваме, че
      $BC\gamma_1 \to^\star_G \alpha$. Заключаваме, че
      \[ \underbrace{A\gamma_1}_{\gamma}\to^\star_G \alpha.\]
    \end{itemize}
  \end{enumerate}
\end{proof}

\begin{framed}
  \begin{lemma}
    За всеки стеков автомат $P$, съществува безконтекстна граматика $G$, такава че $\L(P) = \L(G)$.
  \end{lemma}
\end{framed}
\begin{proof}
  Нека е даден стековия автомат
  \[P = \PDA.\]
  Ще дефинираме безконтекстна граматика $G$, за която $\L(P) = \L(G)$.
  Променливите на граматика са 
  \[V = \{[q,A,p] \mid q,p \in Q, A \in \Gamma\}.\]
  Правилата на $G$ са следните:
  \begin{itemize}
  \item
    Началната променлива е $[\qstart,\sharp,\qaccept]$;
  \item
    Нека имаме $(r,BC) \in \Delta(q, a, A)$, където $a \in \Sigma_\varepsilon$.
    Тогава добавяме правилата в граматиката:
    \[[q,A,p] \to_G a[r,B_1,q'][q',B_2,p],\]
    за всеки две състояние $q'$ и $p$.
  \item
    Нека имаме $(r,B) \in \Delta(q, a, A)$, където $a \in \Sigma_\varepsilon$.
    Тогава добавяме правилата в граматиката:
    \[[q,A,p] \to_G a[r,B,p],\]
    за всяко състояние $p \in Q$.
  \item
    Нека имаме $(p,\varepsilon) \in \Delta(q,a,A)$, където $a \in \Sigma_\varepsilon$.
    Тогава добавяме правилата в граматиката:
    \[[q,A,p] \to a.\]
  \end{itemize}
  Трябва да докажем, че за произволна дума $\alpha \in \Sigma^\star$, произволни състояния $q,p \in Q$,
  и произволен символ $A \in \Gamma$, е изпълнено, че:
  \[[q,A,p] \rightarrow^\star_G \alpha\ \Leftrightarrow\ (q,\alpha,A) \vdash^\star_{P} (p,\varepsilon,\varepsilon).\]
  \begin{description}
  \item[$(\Rightarrow)$]
    С пълна индукция по броят на стъпките $\ell$ в изчислението на стековия автомат $P$ ще докажем, че:
    \[(q,\alpha,A) \vdash^\star_P (p,\varepsilon,\varepsilon)\ \implies\ [q,A,p] \to^\star_G \alpha.\]
    Ако $\ell = 1$, то е лесно, защото $\alpha = a \in \Sigma_\varepsilon$.
    Тогава $(p,\varepsilon) \in \Delta(q,a,A)$ и според конструкцията на граматиката $G$ имаме правилото $[q,A,p] \to_G a$.
    
    Ако $\ell > 1$, то в зависимост от първата стъпка на изчислението, имаме два случая.
    Нека $\alpha = a\beta$, където $a \in \Sigma_\varepsilon$.
    \begin{itemize}
    \item 
      Ако $\Delta(q,a,A) \ni (r,B)$, то имаме, че:
      \[(q,a\beta,A) \vdash_P (r,\beta,B) \vdash^{\ell-1}_P (p, \varepsilon, \varepsilon).\]
      Тогава от И.П. получаваме, че
      \[[r,B,p] \to^\star_G \beta.\]
    \item
      Ако $\Delta(q, a, A) \ni (r, BC)$, то имаме, че:
      \[(q, a\beta, A) \vdash_P (r, \beta, BC) \vdash^{\ell-1}_P (p, \varepsilon, \varepsilon).\]      
      За $\ell-1$ стъпки трябва да стигнем от стек с големина $2$ до празен стек.
      Това означава, че можем да разбием думата $\beta$ на две части, $\beta = \beta_1\beta_2$, със свойството, че след като прочетем $\beta_1$,
      то стекът има големина $1$ и след като прочетем $\beta_2$, то стекът е празен.
      \marginpar{Да обърнем внимание, че в междинните стъпки от двете изчисления, стекът може да расте.}
      Това означава, че съществува състояние $q'$, за което можем да разбием изчислението по следния начин:
      \begin{align*}
        & (r, \beta_1, B) \vdash^{\ell_1}_P (q',\varepsilon,\varepsilon)\\
        & (q', \beta_2, C) \vdash^{\ell_2}_P (p,\varepsilon,\varepsilon).
      \end{align*}
      където $\ell_1 + \ell_2 = \ell - 1$.    
      Сега от {\bf И.П.} получаваме:
      \begin{align*}
        & (r, \beta_1, B) \vdash^{\ell_1}_P (q', \varepsilon, \varepsilon) \implies [r, B, q'] \to^\star_G \beta_1\\
        & (q', \beta_2, C) \vdash^{\ell_2}_P (p, \varepsilon, \varepsilon) \implies [q', C, p] \to^\star_G \beta_2.
      \end{align*}
      Като използваме \Prop{grammar:concat}, получваме, че
      \[[r,B,q'][q',C,p] \to^\star_G \beta_1\beta_2.\]
      Понеже имаме, че $\Delta(q,a,A) \ni (r,BC)$, то в граматиката имаме правилото
      \[[q,A,p] \rightarrow_G a[r,B,q'][q',C,p].\]
      Обединявайки всичко, получаваме извода
      \[[q,A,p] \rightarrow^\star_G \underbrace{a\beta_1\beta_2}_{\alpha}.\]
    \end{itemize}
  \item[$(\Leftarrow)$]
    Този път с пълна индукция по дължината на извода $\ell$ в граматиката $G$ ще докажем, че
    \[[q,A,p] \rightarrow^\star_G \alpha \implies (q,\alpha,A) \vdash^\star_P (p,\varepsilon,\varepsilon).\]
    Ако $\ell = 1$, то имаме $[q,A,p] \rightarrow \alpha$, където $\alpha \in \Sigma_\varepsilon$.
    Този случай е ясен от дефиницията на граматиката $G$, т.е. $\Delta(q,a,A) \ni (p,\varepsilon)$.

    Ако $\ell > 1$, то имаме, че $\alpha = a\beta$ и според правилата на граматиката $G$ имаме два случая.
    \marginpar{Тук отново е възможно $a = \varepsilon$. Това не е проблем, защото правим индукция по дължината на извода, а не по дължината на думата $\alpha$.}
    Ако
    \[[q,A,p] \rightarrow_G a[r,B,p] \stackrel{\ell-1}{\to}_G a\beta,\]
    то директно прилагаме И.П. и получаваме, че
    $(r, \beta, B) \vdash^\star_P (p, \varepsilon, \varepsilon)$ и накрая получаваме, че
    \[(q, a\beta, A) \vdash^\star_P (p, \varepsilon, \varepsilon).\]
    Сега да разгледаме втория случай:
    \[[q,A,p] \rightarrow_G a[r,B,q'][q',C,p] \stackrel{\ell-1}{\to}_G a\beta.\]
    От \Prop{grammar:divide} следва, че имаме разбиване на думата $\beta$ като $\beta = \beta_1\beta_2$, където 
    \begin{align*}
      & [r,B,q'] \stackrel{\ell_1}{\to}_G \beta_1\\
      & [q',C,p] \stackrel{\ell_2}{\to}_G \beta_2.
    \end{align*}
    където $\ell_1 + \ell_2 = \ell - 1$.
    От {\bf И.П.} получаваме, че 
    \begin{align*}
      & [r,B,q'] \stackrel{\ell_1}{\to}_G \beta_1 \implies (r,\beta_1,B) \vdash^\star_P (q',\varepsilon,\varepsilon) \\
      & [q',C,p] \stackrel{\ell_2}{\to}_G \beta_2 \implies (q',\beta_2,C) \vdash^\star_P (p,\varepsilon,\varepsilon).
    \end{align*}
    Правилото
    \[[q,A,p] \rightarrow_G a[r,B,q'][q',C,p]\]
    е добавено в граматиката, защото $\Delta(q,a,A) \ni (r, BC)$. 
    Обединявайки всичко, което знаем, получаваме:
    \begin{align*}
      (q, a\beta, A) & \vdash_P (r, \beta_1\beta_2, BC)\\
                     & \vdash^\star_P (q', \beta_2, C)\\
                     & \vdash^\star_P (p, \varepsilon, \varepsilon).
    \end{align*}    
  \end{description}
\end{proof}

Предишните две леми ни дават следната теорема.
\begin{framed}
\begin{thm}
  \label{th:push-down-context-free}
  Класът на езиците, които се разпознават от краен стеков автомат съвпада с
  класа на безконтекстните езици.
\end{thm}
\end{framed}

\begin{example}
  Нека е дадена граматиката $G$ с правила 
  \begin{align*}
    & S \to AS\ |\ BS\ |\ \varepsilon\\
    & A \to aA\ |\ a\\
    & B \to Bb\ |\ b.
  \end{align*}
  Ще построим стеков автомат $P = \PDA$, такъв че $\L(P) = \L(G)$.
  \begin{itemize}
  \item
    $\Sigma = \{a,b\}$;
  \item 
    $\Gamma = \{A,S,B,a,b,\sharp\}$;
  \item
    $Q = \{\qstart,q,\qaccept\}$;
  \item
    Дефинираме релацията на преходите, следвайки конструкцията от \Th{push-down-context-free}:
    \begin{itemize}
    \item
      $\Delta(\qstart, \varepsilon, \sharp) = \{(q, S\sharp)\}$;
    \item 
      $\Delta(q, \varepsilon, S) = \{(q, AS), (q, BS), (q, \varepsilon)\}$;
    \item
      $\Delta(q, \varepsilon, A) = \{(q, aA), (q, a)\}$;
    \item
      $\Delta(q, \varepsilon, B) = \{(q, Bb), (q, b)\}$;
    \item
      $\Delta(q, a, a) = \{(q, \varepsilon)\}$;
    \item
      $\Delta(q, b, b) = \{(q, \varepsilon)\}$;
    \item
      $\Delta(q, \varepsilon, \sharp) = \{(\qaccept,\varepsilon)\}$;
    \end{itemize}
  \end{itemize}
\end{example}

\begin{framed}
  \begin{thm}
    \label{th:intersection-context-reg}
    Нека $L$ e безконтекстен език и $R$ е регулярен език.
    Тогава тяхното сечение $L \cap R$ е безконтекстен език.
  \end{thm}  
\end{framed}
\begin{hint}
  \marginpar{\cite[стр. 144]{papadimitriou}}
  Нека имаме стеков автомат
  \[P = \pair{Q',\Sigma,\Gamma,\sharp, \Delta', \qstart', \qaccept'}, \text{ където } \L(P) = L,\]
  и краен тотален детерминиран автомат 
  \[\A = \pair{Q'', \Sigma, \qstart'', \delta'', F''}, \text{ където } \L(\A) = R.\]
  \marginpar{Сравнете с конструкцията от \Prop{automata-cap}.}
  Ще определим нов стеков автомат
  \[\M = \PDA,\]
  където
  \begin{itemize}
  \item 
    $Q = Q' \times Q''$;
  \item
    $\qstart = \pair{\qstart',\qstart''}$;
  \item
    $F = \{\qaccept'\} \times F''$;
  \item 
    Функцията на преходите $\Delta$ е дефинирана както следва:
    \begin{itemize}
    \item 
      \marginpar{Симулираме едновременно изчислението и на двата автомата.}
      Ако $(r_1,Z) \in \Delta'(q_1, a, Y)$, то
      \[(\pair{r_1,\delta''(q_2,a)}, Z) \in \Delta(\pair{q_1,q_2},a,Y).\]
    \item
      \marginpar{Нищо не четем от входната дума, следователно правим празен ход на $\A$}
      Ако $(r_1,Z) \in \Delta'(q_1,\varepsilon,Y)$ и всяко $q_2 \in Q''$, то
      \[(\pair{r_1,q_2}, Z) \in \Delta(\pair{q_1,q_2},\varepsilon,Y).\]
    \item
      \marginpar{\writedown Докажете, че $\L(\M) = \L(P) \cap \L(\A)$ !}
      $\Delta$ не съдържа други преходи;
    \end{itemize}
  \end{itemize}

  \begin{itemize}
  \item
    \marginpar{Индукция по броя стъпки в изчислението на $\M$.}
    Докажете, че ако $(\pair{q_1,q_2},\alpha,\gamma) \vdash^\star_\M (\pair{p_1,p_2},\varepsilon,\varepsilon)$, то
    $(q_1,\alpha,\gamma) \vdash^\star_P (p_1,\varepsilon,\varepsilon)$ и $(q_2,\alpha) \vdash^\star_\A (p_2,\varepsilon)$.
  \item
    \marginpar{Индукция по броя стъпки в изчислението на $P$.}
    Докажете, че ако $(q_1,\alpha,\gamma) \vdash^\star_P (p_1,\varepsilon,\varepsilon)$ и $(q_2,\alpha) \vdash^\star_\A (p_2,\varepsilon)$, то
    $(\pair{q_1,q_2},\alpha,\gamma) \vdash^\star_\M (\pair{p_1,p_2},\varepsilon,\varepsilon)$.
  \end{itemize}
  
\end{hint}

\Th{intersection-context-reg} е удобна, когато искаме да докажем, че даден език не е безконтекстен.
С нейна помощ можем да сведем езика до друг, за който вече знаем, че не е безконтекстен.

\begin{example}
  Езикът $L = \{\omega \in \{a,b,c\}^\star \mid N_a(\omega) = N_b(\omega) = N_c(\omega)\}$ не е безконтекстен.
  Да допуснем, че $L$ е безконтекстен език.
  Тогава \[L^\prime = L \cap \L(a^\star b^\star c^\star)\] също е безконтекстен език.
  Но $L^\prime = \{a^nb^nc^n \mid n \in \Nat\}$, за който знаем от \Prob{anbncn}, че {\em не} е безконтекстен.
  Достигнахме до противоречие. Следователно, $L$ не е безконтекстен език.
\end{example}

\begin{framed}
  \begin{remark}
    Не е вярно, че сечението на всеки два безконтекстни езика е безконтекстен език.

    Например, $L_1 = \{a^nb^nc^k \mid n,k\in\Nat\}$ и $L_2 = \{a^kb^nc^n \mid n,k\in\Nat\}$
    са безконтекстни езици, но ние знаем, че
    \[L_1 \cap L_2 = \{a^nb^nc^n \mid n \in \Nat\}\]
    не е безконтекстен.
  \end{remark}
\end{framed}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../eai"
%%% End: 
